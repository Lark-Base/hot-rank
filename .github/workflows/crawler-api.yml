name: Amazon Crawler API

on:
  repository_dispatch:
    types: [crawl-request]
  workflow_dispatch:
    inputs:
      url:
        description: 'Amazon URL to crawl'
        required: true
        type: string

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run crawler
      id: crawler
      run: |
        # è·å–URLå‚æ•°
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          URL="${{ github.event.client_payload.url }}"
        else
          URL="${{ github.event.inputs.url }}"
        fi
        
        echo "Crawling URL: $URL"
        
        # è¿è¡Œçˆ¬è™«å¹¶æ•è·è¾“å‡º
        python amazon_bestsellers_crawler.py "$URL" > crawler_result.json
        
        # è¯»å–ç»“æœ
        RESULT=$(cat crawler_result.json)
        echo "result<<EOF" >> $GITHUB_OUTPUT
        echo "$RESULT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create result comment
      if: github.event_name == 'repository_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          const result = `${{ steps.crawler.outputs.result }}`;
          const parsedResult = JSON.parse(result);
          
          let comment = '## ğŸ•·ï¸ Amazonçˆ¬è™«ç»“æœ\n\n';
          
          if (parsedResult.error) {
            comment += `âŒ **é”™è¯¯**: ${parsedResult.error}\n`;
            if (parsedResult.usage) {
              comment += `\n**ä½¿ç”¨æ–¹æ³•**: ${parsedResult.usage}\n`;
            }
          } else {
            comment += `âœ… **æˆåŠŸçˆ¬å–**: ${parsedResult.count} ä¸ªäº§å“\n`;
            comment += `ğŸ”— **URL**: ${parsedResult.url}\n\n`;
            
            if (parsedResult.data && parsedResult.data.length > 0) {
              comment += '### ğŸ“Š äº§å“åˆ—è¡¨\n\n';
              parsedResult.data.slice(0, 5).forEach((product, index) => {
                comment += `**${product.rank}** ${product.name}\n`;
                comment += `ğŸ’° ä»·æ ¼: ${product.price} | â­ è¯„åˆ†: ${product.rating}\n`;
                comment += `ğŸ”— [æŸ¥çœ‹äº§å“](${product.link})\n\n`;
              });
              
              if (parsedResult.data.length > 5) {
                comment += `... è¿˜æœ‰ ${parsedResult.data.length - 5} ä¸ªäº§å“\n\n`;
              }
            }
          }
          
          comment += `\n---\n*çˆ¬å–æ—¶é—´: ${new Date().toLocaleString('zh-CN')}*`;
          
          // åˆ›å»ºIssueè¯„è®º
          if (context.payload.client_payload && context.payload.client_payload.issue_number) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.client_payload.issue_number,
              body: comment
            });
          }
    
    - name: Upload result as artifact
      uses: actions/upload-artifact@v4
      with:
        name: crawler-result
        path: crawler_result.json
        retention-days: 7